name: CD Release & Deploy

on:
  push:
    branches: [ main ]
    tags: [ 'v*..' ]

permissions:
  contents: write

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  # 1) GitHub Release SOLO cuando el push es un tag
  create-github-release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    # opcional: si usás Environments, activalo y guardá los secrets ahí
    # environment: production
    env:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      COMMIT_SHA: ${{ github.sha }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Token automático para interactuar con la API de GitHub
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          Nueva versión liberada: ${{ github.ref }}
          Este release fue generado automáticamente por el pipeline de CD.
        draft: false
        prerelease: false
        
